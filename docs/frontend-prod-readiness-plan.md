# Frontend Production Readiness Plan

目的: Web フロントエンド (`apps/web`) を本番品質レベルに引き上げるための優先タスク、受入条件、推定工数を示す。

## 要点
- 優先度高: WebSocket フローの堅牢化、アップロード UX、エラー処理、自動テストの追加
- セキュリティ: 認証・CSRF・CORS 対応、Sentry 連携
- 品質: E2E テスト（Playwright）、CI に組み込み

## ステップと受入条件

1) WebSocket / ACK フローの堅牢化
- 内容: `POST /chat` の短い ACK を受けてフロントは即座にカードを作るが、フルデータは `ANALYSIS_COMPLETE` で差し替える。WS 再接続時のイベント整合、重複イベントガード、タイムアウト表示を実装する。
- 受入条件: ネットワーク断後の再接続で `ANALYSIS_COMPLETE` を受け取りカードが正しく更新される。重複で同じ invoice を二重表示しない。
- 推定: 1〜2日

2) アップロード検証とユーザー体験
- 内容: フロント側でファイルタイプ/サイズチェック、アップロード進捗、キャンセル、失敗時の明示的なエラーメッセージを表示する。大型ファイルの分割や遅延アップロードガイドも検討。
- 受入条件: 不適切なファイルは送信前に弾く。ユーザがアップロードをキャンセルできる。アップロード失敗時に再送ボタンを表示。
- 推定: 1日

3) カード描画と一貫した UX
- 内容: サーバーが返す canonical スキーマに合わせ、カードコンポーネントを単一のソースで描画。未完了/解析中/失敗/完了の状態を視覚的に分ける。
- 受入条件: すべてのカードで状態変化が視認可能。UI テストで表示スナップショット合格。
- 推定: 1〜2日

4) エラー処理とリトライ UI
- 内容: WS/HTTP のエラーをユーザに分かりやすく伝え、手動再試行ボタンと自動バックオフ再試行を提供する。DLQ に入ったケースの案内を追加。
- 受入条件: エラー発生時に適切な再試行オプションが表示される。ログに十分な情報が残る。
- 推定: 1日

5) 認証/CSRF/CORS の整備
- 内容: サーバーと合わせて JWT を扱うフローに対応。CORS 設定を限定し、CSRF を防止する。保護されたエンドポイントは UI からトークン付きで呼び出す。
- 受入条件: 非認可アクセスは UI で扱えない。CI テストで認証失敗ケースを検証。
- 推定: 1〜2日

6) 観測性（クライアントメトリクス、Sentry）
- 内容: アップロード/解析完了/WS 再接続などのイベントを計測・送信、Sentry のエラートラッキングとユーザーコンテキスト埋め込みを実装する。
- 受入条件: Sentry でクライアント例外が確認できる。主要イベントがイベント基盤に届く。
- 推定: 0.5〜1日

7) 自動テスト（ユニット/統合/Playwright E2E）
- 内容: コンポーネント単位テスト、`chat` フローの統合テスト、WebSocket を含む E2E を Playwright で追加。CI で実行する。
- 受入条件: PR ごとに E2E が実行され、主要シナリオがカバーされる。
- 推定: 2〜4日（E2E を含む）

8) パフォーマンス最適化／バンドル管理
- 内容: 主要ページの LCP/TTI 計測、画像最適化、遅延ロード、依存削減、コード分割。
- 受入条件: Lighthouse で主要指標が改善される。バンドルサイズ目標値を設定し達成する。
- 推定: 1〜3日

9) アクセシビリティと国際化
- 内容: キーボード操作テスト、ARIA 属性、i18n 対応（日本語/英語）、日付/通貨ローカライズ。
- 受入条件: 主要画面でキーボード操作が可能。i18n スイッチで表示が切り替わる。
- 推定: 1〜2日

10) CI と Lint/型チェックの強化
- 内容: `apps/web` に ESLint/Prettier/TypeScript 型チェック/Playwright E2E を組み込み、PR 必須にする。
- 受入条件: PR ごとに lint/typecheck/E2E が通る。CI が失敗したらマージ不可。
- 推定: 0.5〜2日

## 優先度（短期で着手する順）
短期（今週〜2週）: 1,2,3,7,10
中期（2〜6週）: 4,5,6
長期（6週〜）: 8,9

## 推定合計工数（ラフ）
合計: 約 10〜20 日（E2E と微調整を含む）

## 所有権と次のアクション
- 開発: フロントエンドエンジニア
- QA: E2E 担当
- DevOps: CI・Sentry 設定

次の推奨アクション:
- まず `1. WebSocket/ACK フローの堅牢化` を実装して小さな PR を作成し、`services/ingestion-service` 側の `ANALYSIS_COMPLETE` イベント形状に合わせたテストを追加してください。

---

(このファイルは自動生成されました。追加で詳細なタスク分割が要る場合は教えてください。)