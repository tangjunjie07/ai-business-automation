# 開発タスクと進捗

## 概要
全体のフロー.txt に記載された機能を基にした実装プラン。AI業務自動化システムのフロントエンド・バックエンド統合を目標とする。

## 主要タスク一覧

### 1. UXデザイン：進捗可視化型の実装
- **サブタスク**:
  - ステップ表示UIの設計（アップロード中 → OCR解析中 → AI推論中 → 完了）
  - 進捗バーの実装（shadcn/ui の Progress コンポーネント使用）
  - ユーザーの待ち時間を短縮するアニメーション追加
- **進捗**: 🟢 完了（Progressコンポーネント作成、ステップ表示UI実装）
- **担当**: フロントエンドチーム
- **見積もり**: 2-3日
- **サンプルコード（全体のフロー.txt 参照）**:
  ```tsx
  // 進捗表示の例（Reactコンポーネント）
  const ProgressIndicator = ({ step }: { step: number }) => {
    const steps = ['📄 ファイルをアップロード中...', '🔍 AI OCRが文字を解析中...', '🧠 勘定科目を推論中...', '✅ 解析完了！'];
    return (
      <div>
        {steps.map((s, i) => (
          <p key={i} className={i <= step ? 'text-green-600' : 'text-gray-400'}>{s}</p>
        ))}
      </div>
    );
  };
  ```

### 2. 処理フロー：リアルタイム進捗通知の実装
- **サブタスク**:
  - WebSocket または SSE の導入（Next.js API Routes で WebSocket サーバー）
  - バックエンド（FastAPI）からイベントプッシュ（DOC_RECEIVED, OCR_PROCESSING, AI_THINKING, ANALYSIS_COMPLETE）
  - フロントエンドでのイベント受信とUI更新
- **進捗**: � 完了（バックエンドWebSocket実装、イベント発行完了）
- **担当**: バックエンド・フロントエンドチーム
- **見積もり**: 4-5日
- **サンプルコード（全体のフロー.txt 参照）**:
  ```typescript
  // フロントエンドでのWebSocket接続例
  useEffect(() => {
    const ws = new WebSocket('ws://localhost:8000/ws/progress');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.event === 'OCR_PROCESSING') {
        setProgressStep(1);
      } else if (data.event === 'AI_THINKING') {
        setProgressStep(2);
      } else if (data.event === 'ANALYSIS_COMPLETE') {
        setProgressStep(3);
        setResult(data.result);
      }
    };
    return () => ws.close();
  }, []);
  ```

### 3. フロントエンド（Next.js）でのチャット形式実装
- **サブタスク**:
  - チャットインターフェースの拡張（ファイル添付対応）
  - 解析結果のインタラクティブカード表示（Card コンポーネント使用）
  - 複数ファイルの同時処理表示
- **進捗**: � 完了（ファイル添付対応、解析結果カード表示、WebSocket統合済み）
- **担当**: フロントエンドチーム
- **見積もり**: 3-4日
- **サンプルコード（全体のフロー.txt 参照）**:
  ```tsx
  // 解析結果のカード表示例
  <Card>
    <CardHeader>解析結果: 請求書（株式会社NTT）</CardHeader>
    <CardContent>
      <p>勘定科目: <strong>通信費</strong> (確信度: 98%)</p>
      <p>金額: ¥5,500</p>
      <p>プロジェクト: BWC-2024-01</p>
    </CardContent>
    <CardFooter>
      <Button>マネーフォワードへ登録</Button>
      <Button variant="outline">修正する</Button>
    </CardFooter>
  </Card>
  ```

### 4. WebSocket/通信プロトコルの設計と実装
- **サブタスク**:
  - WebSocket 接続の確立（フロント ↔ バックエンド）
  - job_id の発行と管理
  - イベントメッセージの定義と送信
  - エラーハンドリング（接続切断、再接続）
- **進捗**: � 完了（WebSocketエンドポイント、接続管理、イベント送信完了）
- **担当**: バックエンドチーム
- **見積もり**: 3-4日
- **サンプルコード（全体のフロー.txt 参照）**:
  ```python
  # FastAPIでのWebSocket例（簡易）
  from fastapi import WebSocket
  @app.websocket("/ws/progress")
  async def websocket_endpoint(websocket: WebSocket):
      await websocket.accept()
      await websocket.send_json({"event": "DOC_RECEIVED", "job_id": "123"})
      # 処理ステップごとに送信
      await websocket.send_json({"event": "OCR_PROCESSING"})
      await websocket.send_json({"event": "AI_THINKING"})
      await websocket.send_json({"event": "ANALYSIS_COMPLETE", "result": {...}})
  ```

### 5. APIレスポンスの型定義
- **サブタスク**:
  - TypeScript インターフェースの定義（AnalysisResult, Message など）
  - types/ ディレクトリへの追加
  - フロントエンドでの型安全性の確保
- **進捗**: � 完了（types/analysis.ts 作成済み）
- **担当**: フロントエンドチーム
- **見積もり**: 1-2日
- **サンプルコード（全体のフロー.txt 参照）**:
  ```typescript
  // types/analysis.ts に追加
  interface AnalysisResult {
    jobId: string;
    status: 'success' | 'error';
    data?: {
      vendorName: string;
      invoiceDate: string;
      totalAmount: number;
      currency: string;
      accounting: {
        accountItem: string;
        confidence: number;
        reasoning: string;
      };
      projectId: string;
    };
    error?: string;
  }
  ```

### 6. バックエンド統合（Ingestion Service）
- **サブタスク**:
  - WebSocket イベントの発行（OCR開始/完了、AI分析開始/完了）
  - 非同期処理の強化（Celery 導入検討）
  - マルチテナント対応の確認
- **進捗**: � 完了（WebSocketイベント発行、OCR/AI分析統合済み）
- **担当**: バックエンドチーム
- **見積もり**: 2-3日

## 全体進捗
- **完了率**: 約95%（全主要機能実装完了）
- **次のステップ**: テストと統合確認
- **リスク**: WebSocket のクロスオリジン対応、バックエンドの非同期処理

## 更新履歴
- 2026-01-11: 初回作成、現在の実装状況に基づくタスク定義
- 2026-01-11: サンプルコード追加（全体のフロー.txt 参照）
- 2026-01-11: 全タスク完了、実装完了
- 2026-01-11: 順次実装完了（型定義、WebSocket、UI拡張）