# DB マイグレーション手順（バックアップ→マイグレーション→スモーク）

目的
- 本番環境でのデータ損失を避けつつ、安全にスキーマ変更を適用するための手順。

前提
- DB への管理者アクセス権（バックアップ取得権限）を持つこと。

手順（短縮版）
1. バックアップ
   - `pg_dump -h <host> -U <user> -Fc -f backup-$(date +%F).dump <db>`
   - バックアップの整合性を確認（復元先でのテスト復元を推奨）。
2. ステージングでマイグレーション実行
   - `prisma migrate deploy`（またはプロジェクトで使っているマイグレーションコマンド）
   - マイグレーション後にアプリのスモークテストを実行。
3. 本番実行（ウィンドウを設定）
   - メンテナンス時間を計画し、トラフィックを最小化する。
   - 本番で `prisma migrate deploy` を実行。
4. スモークテスト
   - ヘルスチェック、主要 API の簡易フロー（ログイン→データ取得→作成）を実行。
   - RLS が働いているか簡易確認（テナント分離テスト）。
5. ロールバック手順
   - 事前にロールバック手順を検討する。複雑な破壊的マイグレーションは段階的に行う。
   - 必要であればバックアップから復元: `pg_restore -h <host> -U <user> -d <db> backup.dump`

チェックポイント（合格条件）
- バックアップ取得と検証が完了している。
- スモークテストが成功し、主要機能が動作している。
- モニタリングとアラート（エラー・パフォーマンス）が正常であること。
