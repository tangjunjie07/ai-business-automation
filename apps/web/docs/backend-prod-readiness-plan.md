# Backend Production Readiness Plan

目的: `services/ingestion-service` を本番品質に引き上げるための優先作業一覧と受入条件を示す。

## 概要（要点）
- 最優先: 必須構成チェック、ヘルス/レディネス、メトリクス、構造化ログ
- セキュリティ: 認証/認可、CORS 制御、秘密管理
- 信頼性: RLS 保証、外部 API の再試行/タイムアウト、バックグラウンドタスク制御
- 品質: テスト拡充、CI 強化、運用ドキュメント整備

## プラン（ステップ）
1. 必須構成チェック導入
   - 目的: 起動時に必須環境変数が欠落しているときに明示的に失敗または警告を出す（`REQUIRE_CREDENTIALS` で制御）。
   - 受入条件: 起動ログに欠落項目が明示される。`REQUIRE_CREDENTIALS=true` のときは起動に失敗する。

2. ヘルス/レディネス/メトリクス
   - 目的: オーケストレーションと監視用に `/health` `/ready` を提供し、Prometheus によるメトリクス収集を可能にする。
   - 受入条件: `/health` が `200`、`/ready` が DB 接続や外部依存のヘルスチェックを反映する。`/metrics` をスクレイピング可能。

3. 構造化ログとトレース導入
   - 目的: 障害時の調査を容易にするため、`job_id` を常に付与した JSON ライクなログと分散トレースを導入する。
   - 受入条件: 例外発生時に trace/span が残る。ログは JSON で GCP/Datadog/Elastic に投入可能。

4. 認証・認可の強化
   - 目的: API へのアクセス制御（JWT/OAuth2）と権限モデルを追加し、悪意あるアクセスを防止する。
   - 受入条件: 管理 API は認証済みでないと呼び出せない。テストでヘッダ付き/無しの振る舞いを確認。

5. RLS とバックグラウンド接続の保証
   - 目的: マルチテナントの隔離を確実にするため、ワーカや背景タスクの DB 接続でも `app.current_tenant_id` をセットするユーティリティを提供する。
   - 受入条件: 背景実行で作成されたレコードが別テナントに漏れない（簡易統合テストで確認）。

6. 外部APIの堅牢化
   - 目的: OCR/LLM 呼び出しのタイムアウト、指数バックオフ、失敗時の代替パス（stub or DLQ）を実装する。
   - 受入条件: 外部が不安定でもサービスが全体停止しない。最大リトライ回数と SLA が設定される。

7. バックグラウンドタスク管理の改善
   - 目的: 同時実行制御、ジョブ再実行戦略、作業キュー（将来的には Redis/Celery）を整備する。
   - 受入条件: 同時ジョブ数の上限が働き、長時間ジョブは監視/アラートされる。

8. セキュリティと運用ルール
   - 目的: CORS 制限、シークレット管理（Vault/KMS）、依存性スキャン、脆弱性ポリシーを整備する。
   - 受入条件: デフォルトで CORS 制限がかかり、Secrets は環境変数以外の安全なストアに置くドキュメントがある。

9. テストとCI強化
   - 目的: ユニット・統合・E2E テストの拡充、CI に lint/mypy/pytest を組み込む。
   - 受入条件: PR ごとに CI が回り、主要パス（/chat, websocket, stub flow）の E2E が通る。

10. ドキュメントと運用手順整備
   - 目的: 起動手順、環境変数一覧、運用 runbook（障害時対応、ログ確認、再デリバリ手順）を作成する。
   - 受入条件: `Docs/` に runbook があり、オンコールが参照できる。

## 優先度と推奨着手順（短期→中期）
- 短期（今週〜2週）: 1,2,9,10
- 中期（2〜6週）: 3,5,6,7
- 長期（6週〜）: 4,8

## 推定工数（ラフ）
- 1: 0.5日
- 2: 1〜2日
- 3: 2〜4日
- 4: 3〜6日
- 5: 1〜2日
- 6: 2〜4日
- 7: 1〜3日（短期改善）→ 中長期でキュー導入 1〜2 週
- 8: 2〜5日（ポリシー/ツール導入含む）
- 9: 1〜3日（CI 増強は継続的作業）
- 10: 0.5〜2日

## 所有権と次のアクション
- 開発担当: バックエンドエンジニア
- QA: テスト担当
- DevOps: メトリクス・シークレット・CI 設定

次のアクション（推奨）:
- 今すぐ: `Docs/backend-prod-readiness-plan.md` を確認 → 1 を適用して PR を作成し CI を回す。

---

(このファイルは自動生成されました。追加の詳細や分割チケットを作成しますか？)