# RLS とアプリ側テナントチェックのペアテスト手順

目的
- 本番相当環境でDBレベルのRLS（Row-Level Security）とアプリ側のテナント判定（例: `X-Tenant-ID` / セッション変数）の整合性を確認する。

前提
- ステージングまたはローカルで本番に近いDBスキーマとRLSポリシーが適用されていること。

テストケース（短縮版）
1. テナントA に属するリソースのみ取得できること
   - ヘッダ `X-Tenant-ID: tenant-a` を付与して API を呼ぶ。
   - レスポンスに tenant-b のデータが含まれないことを確認。
2. テナント間の書き込み隔離
   - `POST /invoices` 等で tenant-a に対する作成を行い、tenant-b の一覧に現れないことを確認。
3. セッション変数経由のRLS検証
   - DB 接続時に `SET app.current_tenant_id = 'tenant-a'` を行うパスと、リクエストヘッダ経由でミドルウェアが設定するパス両方を検証する。
4. 異常系（想定外の tenant_id または未指定）
   - テナント未指定のリクエストは拒否または 400/401 を返すことを確認。

実行手順（簡単）
1. ステージング DB をスナップショットから復元（または本番と同等のデータ量で構築）。
2. テスト用ユーザ／テナントを作成（tenant-a, tenant-b）。
3. ミドルウェアのログを有効にして、`X-Tenant-ID`→`SET app.current_tenant_id` の流れをトレース。
4. 上のテストケースを順に実行（スクリプト化推奨、cURL または Postman で再現）。
5. 結果が期待どおりでない場合、どちらのレイヤ（アプリ/DB）で欠落があるかを分けて修正。

チェックポイント（合格条件）
- すべてのAPIにてテナント境界が保たれている。
- ミドルウェアのログに tenant 設定が記録され、DB 側のセッション変数と一致する。
- 未指定や不正な tenant のアクセスは拒否される。
