name: Workspace PR Tests

on:
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'apps/web/**'

jobs:
  pr-tests:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          cd apps/web
          npm install --no-audit --no-fund

      - name: Run tests with report
        env:
          CI: true
        run: |
          set +e
          cd apps/web
          if [ -f .env.example ] && [ ! -f .env.local ]; then
            cp .env.example .env.local
          fi
          npm run lint > ../../agent-test-report.txt 2>&1
          LINT_STATUS=$?
          npm run build >> ../../agent-test-report.txt 2>&1
          BUILD_STATUS=$?
          npx playwright install --with-deps >> ../../agent-test-report.txt 2>&1
          npm run test:e2e >> ../../agent-test-report.txt 2>&1
          E2E_STATUS=$?
          echo "lint=$LINT_STATUS build=$BUILD_STATUS e2e=$E2E_STATUS" >> ../../agent-test-report.txt
          if [ $LINT_STATUS -ne 0 ] || [ $BUILD_STATUS -ne 0 ] || [ $E2E_STATUS -ne 0 ]; then
            echo "TEST_STATUS=failed" >> $GITHUB_ENV
          else
            echo "TEST_STATUS=passed" >> $GITHUB_ENV
          fi
          exit 0

      - name: Comment test report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = `${process.env.GITHUB_WORKSPACE}/agent-test-report.txt`;
            const report = fs.existsSync(reportPath) ? fs.readFileSync(reportPath, 'utf-8') : 'No test report found.';
            const summary = {
              lint: report.includes('lint=0') ? 'pass' : 'warn/fail',
              build: report.includes('build=0') ? 'pass' : 'fail',
              e2e: report.includes('e2e=0') ? 'pass' : 'fail',
            };
            const body = `## Test Report\n- Lint: ${summary.lint}\n- Build: ${summary.build}\n- E2E: ${summary.e2e}\n\n<details>\n<summary>Logs</summary>\n\n\`\`\`\n${report}\n\`\`\`\n</details>\n`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail if tests failed
        if: env.TEST_STATUS == 'failed'
        run: exit 1
