name: Workspace PR Tests

on:
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'apps/web/**'

jobs:
  pr-tests:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ai_business_automation_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          cd apps/web
          npm install --no-audit --no-fund

      - name: Run tests with report
        env:
          CI: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/ai_business_automation_test
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          DIFY_API_BASE: ${{ secrets.DIFY_API_BASE }}
          E2E_TENANT_CODE: "0001"
          E2E_EMAIL: admin@gmail.com
          E2E_PASSWORD: 123456
        run: |
          set +e
          cd apps/web
          if [ -f .env.example ] && [ ! -f .env.local ]; then
            cp .env.example .env.local
          fi
          echo "=== prisma migrate reset ===" >> ../../agent-test-report.txt
          npx prisma migrate reset --force --schema prisma/schema.prisma >> ../../agent-test-report.txt 2>&1
          echo "=== prisma db seed ===" >> ../../agent-test-report.txt
          npx prisma db seed --schema prisma/schema.prisma >> ../../agent-test-report.txt 2>&1
          echo "=== lint ===" >> ../../agent-test-report.txt
          npm run lint >> ../../agent-test-report.txt 2>&1
          LINT_STATUS=$?
          npm run build >> ../../agent-test-report.txt 2>&1
          BUILD_STATUS=$?
          npx playwright install --with-deps >> ../../agent-test-report.txt 2>&1
          npm run test:e2e >> ../../agent-test-report.txt 2>&1
          E2E_STATUS=$?
          echo "lint=$LINT_STATUS build=$BUILD_STATUS e2e=$E2E_STATUS" >> ../../agent-test-report.txt
          if [ $LINT_STATUS -ne 0 ] || [ $BUILD_STATUS -ne 0 ] || [ $E2E_STATUS -ne 0 ]; then
            echo "TEST_STATUS=failed" >> $GITHUB_ENV
          else
            echo "TEST_STATUS=passed" >> $GITHUB_ENV
          fi
          exit 0

      - name: Comment test report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = `${process.env.GITHUB_WORKSPACE}/agent-test-report.txt`;
            const report = fs.existsSync(reportPath) ? fs.readFileSync(reportPath, 'utf-8') : 'No test report found.';
            const summary = {
              lint: report.includes('lint=0') ? 'pass' : 'warn/fail',
              build: report.includes('build=0') ? 'pass' : 'fail',
              e2e: report.includes('e2e=0') ? 'pass' : 'fail',
            };
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const body = `## Test Report\n- Lint: ${summary.lint}\n- Build: ${summary.build}\n- E2E: ${summary.e2e}\n\nArtifacts (screenshots/report):\n\`\`\`\n${runUrl}\n\`\`\`\n\n<details>\n<summary>Logs</summary>\n\n\`\`\`\n${report}\n\`\`\`\n</details>\n`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            apps/web/playwright-report
            apps/web/test-results
            agent-test-report.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Fail if tests failed
        if: env.TEST_STATUS == 'failed'
        run: exit 1
