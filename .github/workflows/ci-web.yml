name: CI - apps/web

on:
  push:
    paths:
      - 'apps/web/**'
  pull_request:
    paths:
      - 'apps/web/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: [staging, production]
    env:
      RELEASE_PROFILE: ${{ matrix.profile }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
      - name: Run lint
        run: |
          cd apps/web
          if [ -f package.json ]; then npm run lint || true; fi
      - name: Run tests
        run: |
          cd apps/web
          if [ -f package.json ]; then npm test || true; fi
      - name: Prepare env file from Secrets (per-profile)
        run: |
          set -e
          PROFILE=${{ matrix.profile }}
          if [ "$PROFILE" = "production" ]; then
            echo "Generating .env.production for production"
            cat > apps/web/.env.production <<EOF
NODE_ENV=production
RELEASE_PROFILE=production
NEXT_PUBLIC_ENV=production

# Database
DATABASE_URL=${{ secrets.DATABASE_URL_PROD }}

# NextAuth
NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL_PROD }}
NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET_PROD }}

# Storage (provider: local | s3 | azure)
STORAGE_PROVIDER=${{ secrets.STORAGE_PROVIDER_PROD }}
AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET_PROD }}
AWS_REGION=${{ secrets.AWS_REGION_PROD }}
AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}

# Sentry
SENTRY_DSN=${{ secrets.SENTRY_DSN_PROD }}
SENTRY_ENVIRONMENT=production
SENTRY_TRACES_SAMPLE_RATE=${{ secrets.SENTRY_TRACES_SAMPLE_RATE_PROD }}

# Ingestion / OCR service endpoint
INGESTION_URL=${{ secrets.INGESTION_URL_PROD }}
EOF
          else
            echo "Generating .env.production for staging"
            cat > apps/web/.env.production <<EOF
NODE_ENV=production
RELEASE_PROFILE=staging
NEXT_PUBLIC_ENV=staging

# Database
DATABASE_URL=${{ secrets.DATABASE_URL_STAGING }}

# NextAuth
NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL_STAGING }}
NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET_STAGING }}

# Storage (provider: local | s3 | azure)
STORAGE_PROVIDER=${{ secrets.STORAGE_PROVIDER_STAGING }}
AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET_STAGING }}
AWS_REGION=${{ secrets.AWS_REGION_STAGING }}
AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID_STAGING }}
AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING }}

# Sentry
SENTRY_DSN=${{ secrets.SENTRY_DSN_STAGING }}
SENTRY_ENVIRONMENT=staging
SENTRY_TRACES_SAMPLE_RATE=${{ secrets.SENTRY_TRACES_SAMPLE_RATE_STAGING }}

# Ingestion / OCR service endpoint
INGESTION_URL=${{ secrets.INGESTION_URL_STAGING }}
EOF
          fi
      - name: Build
        run: |
          cd apps/web
          npm run build
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ matrix.profile }}
          path: |
            apps/web/.next
            apps/web/package.json
            apps/web/public
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Download build artifact (staging)
        uses: actions/download-artifact@v4
        with:
          name: web-build-staging
          path: ./build
      - name: Deploy to Staging (placeholder)
        env:
          DEPLOY_API_KEY: ${{ secrets.DEPLOY_API_KEY_STAGING }}
        run: |
          echo "Deploying staging with artifact web-build-staging"
          # Add platform-specific deploy commands here (e.g. rsync, kubectl, serverless deploy)

  deploy-production:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Download build artifact (production)
        uses: actions/download-artifact@v4
        with:
          name: web-build-production
          path: ./build
      - name: Deploy to Production (placeholder)
        env:
          DEPLOY_API_KEY: ${{ secrets.DEPLOY_API_KEY_PROD }}
        run: |
          echo "Deploying production with artifact web-build-production"
          # Add platform-specific deploy commands here (e.g. kubectl rollout, terraform apply)

