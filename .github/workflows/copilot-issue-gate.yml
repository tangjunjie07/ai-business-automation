name: Copilot Issue Gate

on:
  issue_comment:
    types: [created]

jobs:
  gate:
    if: contains(github.event.comment.body, '@copilot')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Validate issue details
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (issue.pull_request) {
              core.info('Skip: comment is on a pull request.');
              return;
            }

            const body = issue.body || '';
            const requiredSections = [
              { title: 'Summary', allowNA: false },
              { title: 'Steps to Reproduce', allowNA: false },
              { title: 'Expected Behavior', allowNA: false },
              { title: 'Actual Behavior', allowNA: false },
              { title: 'Environment', allowNA: false },
              { title: 'Logs / Screenshots', allowNA: true },
            ];

            const escapeRegExp = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const sectionContent = (title) => {
              const pattern = new RegExp(`^#{2,3}\\s*${escapeRegExp(title)}\\s*\\n([\\s\\S]*?)(?=\\n#{2,3}\\s|$)`, 'im');
              const match = body.match(pattern);
              return match ? match[1].trim() : '';
            };

            const isMissing = (content, allowNA) => {
              if (!content) return true;
              const normalized = content.replace(/\s+/g, ' ').trim().toLowerCase();
              if (allowNA) return false;
              return ['n/a', 'na', 'none', 'null', 'todo', 'tbd'].includes(normalized);
            };

            const missing = [];
            for (const section of requiredSections) {
              const content = sectionContent(section.title);
              if (isMissing(content, section.allowNA)) {
                missing.push(section.title);
              }
            }

            const { owner, repo } = context.repo;

            if (missing.length > 0) {
              const missingList = missing.map((item) => `- ${item}`).join('\n');
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: `@${context.payload.comment.user.login} I need a bit more detail before @copilot can start. Please fill in:\n\n${missingList}\n\nOnce updated, mention @copilot again and I will proceed.`
              });
              return;
            }

            const labelName = 'copilot-ready';
            try {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: labelName,
                color: '0E8A16',
                description: 'Issue has enough detail for Copilot to start.'
              });
            } catch (error) {
              if (error.status !== 422) throw error;
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issue.number,
              labels: [labelName]
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: `@${context.payload.comment.user.login} Thanks! The issue has enough detail. @copilot can start now. I added the ${labelName} label and will expect a PR next.`
            });
